{"ast":null,"code":"import _objectSpread from\"E:/EMS/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import{createContext,useState,useEffect,useCallback}from\"react\";import{jsx as _jsx}from\"react/jsx-runtime\";export const AuthContext=/*#__PURE__*/createContext();const TOKEN_KEY=process.env.REACT_APP_TOKEN_KEY||\"auth_token\";// Helper to safely access localStorage\nconst getLocalStorage=()=>{if(typeof window!==\"undefined\"&&window.localStorage){return window.localStorage;}return null;};// Parse JWT token to get user info\nconst parseJwt=token=>{try{const base64Url=token.split('.')[1];const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');const jsonPayload=decodeURIComponent(atob(base64).split('').map(function(c){return'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2);}).join(''));return JSON.parse(jsonPayload);}catch(error){console.error('Error parsing JWT token:',error);return null;}};// Check if token is expired\nconst isTokenExpired=token=>{try{const decoded=parseJwt(token);if(!decoded||!decoded.exp)return true;// Check if expiration time is in the past (in seconds)\nconst currentTime=Math.floor(Date.now()/1000);return decoded.exp<currentTime;}catch(error){console.error('Error checking token expiration:',error);return true;}};export function AuthProvider(_ref){let{children}=_ref;const[user,setUser]=useState(null);const[loading,setLoading]=useState(true);const[isAuthenticated,setIsAuthenticated]=useState(false);// Initialize authentication state\nuseEffect(()=>{const initializeAuth=()=>{const storage=getLocalStorage();if(storage){const token=storage.getItem(TOKEN_KEY);if(token&&!isTokenExpired(token)){const decodedToken=parseJwt(token);if(decodedToken){var _decodedToken$role;setUser({token,username:decodedToken===null||decodedToken===void 0?void 0:decodedToken.sub,role:decodedToken===null||decodedToken===void 0?void 0:(_decodedToken$role=decodedToken.role)===null||_decodedToken$role===void 0?void 0:_decodedToken$role.replace(\"ROLE_\",\"\"),id:(decodedToken===null||decodedToken===void 0?void 0:decodedToken.userId)||(decodedToken===null||decodedToken===void 0?void 0:decodedToken.id),email:decodedToken===null||decodedToken===void 0?void 0:decodedToken.email});setIsAuthenticated(true);}else{// Invalid token, clear it\nstorage.removeItem(TOKEN_KEY);}}else if(token&&isTokenExpired(token)){// Token expired, clear it\nstorage.removeItem(TOKEN_KEY);}}setLoading(false);};initializeAuth();},[]);// Set up token expiration check\nuseEffect(()=>{if(!user||!user.token)return;const checkTokenExpiration=()=>{if(isTokenExpired(user.token)){logout();}};// Check every minute\nconst interval=setInterval(checkTokenExpiration,60000);return()=>clearInterval(interval);},[user]);const login=useCallback(token=>{const storage=getLocalStorage();if(storage){storage.setItem(TOKEN_KEY,token);}const decodedToken=parseJwt(token);if(decodedToken){var _decodedToken$role2;const userData={token,username:decodedToken===null||decodedToken===void 0?void 0:decodedToken.sub,role:decodedToken===null||decodedToken===void 0?void 0:(_decodedToken$role2=decodedToken.role)===null||_decodedToken$role2===void 0?void 0:_decodedToken$role2.replace(\"ROLE_\",\"\"),id:(decodedToken===null||decodedToken===void 0?void 0:decodedToken.userId)||(decodedToken===null||decodedToken===void 0?void 0:decodedToken.id),email:decodedToken===null||decodedToken===void 0?void 0:decodedToken.email};setUser(userData);setIsAuthenticated(true);return userData;}else{throw new Error('Invalid token format');}},[]);const logout=useCallback(()=>{const storage=getLocalStorage();if(storage){storage.removeItem(TOKEN_KEY);}setUser(null);setIsAuthenticated(false);},[]);const hasRole=useCallback(role=>{return(user===null||user===void 0?void 0:user.role)===role;},[user]);const hasAnyRole=useCallback(roles=>{return roles.includes(user===null||user===void 0?void 0:user.role);},[user]);const updateUser=useCallback(userData=>{if(user){setUser(prevUser=>_objectSpread(_objectSpread({},prevUser),userData));}},[user]);const value={user,loading,isAuthenticated,login,logout,hasRole,hasAnyRole,updateUser};return/*#__PURE__*/_jsx(AuthContext.Provider,{value:value,children:children});}","map":{"version":3,"names":["createContext","useState","useEffect","useCallback","jsx","_jsx","AuthContext","TOKEN_KEY","process","env","REACT_APP_TOKEN_KEY","getLocalStorage","window","localStorage","parseJwt","token","base64Url","split","base64","replace","jsonPayload","decodeURIComponent","atob","map","c","charCodeAt","toString","slice","join","JSON","parse","error","console","isTokenExpired","decoded","exp","currentTime","Math","floor","Date","now","AuthProvider","_ref","children","user","setUser","loading","setLoading","isAuthenticated","setIsAuthenticated","initializeAuth","storage","getItem","decodedToken","_decodedToken$role","username","sub","role","id","userId","email","removeItem","checkTokenExpiration","logout","interval","setInterval","clearInterval","login","setItem","_decodedToken$role2","userData","Error","hasRole","hasAnyRole","roles","includes","updateUser","prevUser","_objectSpread","value","Provider"],"sources":["E:/EMS/frontend/src/context/AuthContext.jsx"],"sourcesContent":["import { createContext, useState, useEffect, useCallback } from \"react\";\r\n\r\nexport const AuthContext = createContext();\r\n\r\nconst TOKEN_KEY = process.env.REACT_APP_TOKEN_KEY || \"auth_token\";\r\n\r\n// Helper to safely access localStorage\r\nconst getLocalStorage = () => {\r\n    if (typeof window !== \"undefined\" && window.localStorage) {\r\n        return window.localStorage;\r\n    }\r\n    return null;\r\n};\r\n\r\n// Parse JWT token to get user info\r\nconst parseJwt = (token) => {\r\n    try {\r\n        const base64Url = token.split('.')[1];\r\n        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\r\n        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {\r\n            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);\r\n        }).join(''));\r\n        return JSON.parse(jsonPayload);\r\n    } catch (error) {\r\n        console.error('Error parsing JWT token:', error);\r\n        return null;\r\n    }\r\n};\r\n\r\n// Check if token is expired\r\nconst isTokenExpired = (token) => {\r\n    try {\r\n        const decoded = parseJwt(token);\r\n        if (!decoded || !decoded.exp) return true;\r\n        \r\n        // Check if expiration time is in the past (in seconds)\r\n        const currentTime = Math.floor(Date.now() / 1000);\r\n        return decoded.exp < currentTime;\r\n    } catch (error) {\r\n        console.error('Error checking token expiration:', error);\r\n        return true;\r\n    }\r\n};\r\n\r\nexport function AuthProvider({ children }) {\r\n    const [user, setUser] = useState(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isAuthenticated, setIsAuthenticated] = useState(false);\r\n\r\n    // Initialize authentication state\r\n    useEffect(() => {\r\n        const initializeAuth = () => {\r\n            const storage = getLocalStorage();\r\n            if (storage) {\r\n                const token = storage.getItem(TOKEN_KEY);\r\n                if (token && !isTokenExpired(token)) {\r\n                    const decodedToken = parseJwt(token);\r\n                    if (decodedToken) {\r\n                        setUser({\r\n                            token,\r\n                            username: decodedToken?.sub,\r\n                            role: decodedToken?.role?.replace(\"ROLE_\", \"\"),\r\n                            id: decodedToken?.userId || decodedToken?.id,\r\n                            email: decodedToken?.email\r\n                        });\r\n                        setIsAuthenticated(true);\r\n                    } else {\r\n                        // Invalid token, clear it\r\n                        storage.removeItem(TOKEN_KEY);\r\n                    }\r\n                } else if (token && isTokenExpired(token)) {\r\n                    // Token expired, clear it\r\n                    storage.removeItem(TOKEN_KEY);\r\n                }\r\n            }\r\n            setLoading(false);\r\n        };\r\n\r\n        initializeAuth();\r\n    }, []);\r\n\r\n    // Set up token expiration check\r\n    useEffect(() => {\r\n        if (!user || !user.token) return;\r\n\r\n        const checkTokenExpiration = () => {\r\n            if (isTokenExpired(user.token)) {\r\n                logout();\r\n            }\r\n        };\r\n\r\n        // Check every minute\r\n        const interval = setInterval(checkTokenExpiration, 60000);\r\n        \r\n        return () => clearInterval(interval);\r\n    }, [user]);\r\n\r\n    const login = useCallback((token) => {\r\n        const storage = getLocalStorage();\r\n        if (storage) {\r\n            storage.setItem(TOKEN_KEY, token);\r\n        }\r\n        \r\n        const decodedToken = parseJwt(token);\r\n        if (decodedToken) {\r\n            const userData = {\r\n                token,\r\n                username: decodedToken?.sub,\r\n                role: decodedToken?.role?.replace(\"ROLE_\", \"\"),\r\n                id: decodedToken?.userId || decodedToken?.id,\r\n                email: decodedToken?.email\r\n            };\r\n            setUser(userData);\r\n            setIsAuthenticated(true);\r\n            return userData;\r\n        } else {\r\n            throw new Error('Invalid token format');\r\n        }\r\n    }, []);\r\n\r\n    const logout = useCallback(() => {\r\n        const storage = getLocalStorage();\r\n        if (storage) {\r\n            storage.removeItem(TOKEN_KEY);\r\n        }\r\n        setUser(null);\r\n        setIsAuthenticated(false);\r\n    }, []);\r\n\r\n    const hasRole = useCallback((role) => {\r\n        return user?.role === role;\r\n    }, [user]);\r\n\r\n    const hasAnyRole = useCallback((roles) => {\r\n        return roles.includes(user?.role);\r\n    }, [user]);\r\n\r\n    const updateUser = useCallback((userData) => {\r\n        if (user) {\r\n            setUser(prevUser => ({ ...prevUser, ...userData }));\r\n        }\r\n    }, [user]);\r\n\r\n    const value = {\r\n        user,\r\n        loading,\r\n        isAuthenticated,\r\n        login,\r\n        logout,\r\n        hasRole,\r\n        hasAnyRole,\r\n        updateUser\r\n    };\r\n\r\n    return (\r\n        <AuthContext.Provider value={value}>\r\n            {children}\r\n        </AuthContext.Provider>\r\n    );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}